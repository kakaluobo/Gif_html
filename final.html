<script>
    let currentGifId = null;
    const gifStates = {
        1: { 
            element: null,
            originalSrc: null
        },
        2: { 
            element: null,
            originalSrc: null
        },
        3: { 
            element: null,
            originalSrc: null
        }
    };

    // 关闭页面函数 - 直接关闭，无确认对话框
    function closePage() {
        window.close();
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有GIF元素
        for (let i = 1; i <= 3; i++) {
            const gifElement = document.querySelector(`.gif-img[data-id="${i}"]`);
            if (gifElement) {
                gifStates[i].element = gifElement;
                gifStates[i].originalSrc = gifElement.src.split('?')[0]; // 存储纯净的URL
            }
        }
    });

    // 重新播放单个GIF
    function restartGif(gifId) {
        const state = gifStates[gifId];
        if (!state || !state.element) return;
        
        const gifElement = state.element;
        const originalSrc = state.originalSrc;
        
        // 重新加载GIF - 使用时间戳强制刷新
        gifElement.src = '';
        setTimeout(() => {
            gifElement.src = originalSrc + '?t=' + new Date().getTime();
        }, 100);
    }

    // 打开全屏模态框
    function openFullscreen(gifId) {
        const modal = document.getElementById('fullscreenModal');
        const fullscreenGif = document.getElementById('fullscreenGif');
        const modalTitle = document.getElementById('modalTitle');
        const state = gifStates[gifId];
        
        currentGifId = gifId;
        
        // 显示动图 - 使用时间戳确保最新
        fullscreenGif.src = state.originalSrc + '?t=' + new Date().getTime();
        
        // 设置标题
        const titles = {
            1: '界面松弛动态过程',
            2: '旋节分解演化过程', 
            3: '液滴凝聚过程'
        };
        modalTitle.textContent = titles[gifId];
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // 关闭全屏模态框
    function closeFullscreen() {
        const modal = document.getElementById('fullscreenModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        currentGifId = null;
    }

    // 重新播放当前全屏动图
    function restartCurrentGif() {
        if (currentGifId) {
            const state = gifStates[currentGifId];
            const fullscreenGif = document.getElementById('fullscreenGif');
            
            // 重新加载全屏GIF - 使用时间戳强制刷新
            const originalSrc = state.originalSrc;
            fullscreenGif.src = '';
            setTimeout(() => {
                fullscreenGif.src = originalSrc + '?t=' + new Date().getTime();
            }, 100);
            
            // 同时更新小图的GIF状态
            const smallGif = state.element;
            if (smallGif) {
                smallGif.src = '';
                setTimeout(() => {
                    smallGif.src = originalSrc + '?t=' + new Date().getTime();
                }, 100);
            }
        }
    }

    // 键盘控制
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('fullscreenModal');
        
        if (modal.style.display === 'flex') {
            switch(event.key) {
                case 'Escape':
                    closeFullscreen();
                    break;
                case 'r':
                case 'R':
                    event.preventDefault();
                    restartCurrentGif();
                    break;
            }
        } else {
            // 在正常模式下也可以按ESC关闭页面
            if (event.key === 'Escape') {
                closePage();
            }
        }
    });

    // 点击模态框背景关闭
    document.getElementById('fullscreenModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeFullscreen();
        }
    });

    // 阻止图片拖动
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('dragstart', (e) => e.preventDefault());
    });
</script>
